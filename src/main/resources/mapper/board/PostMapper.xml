<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="post">

    <select id="count" resultType="int" parameterType="map">
        SELECT COUNT(*) FROM post
        <if test="column != null and find != null">
            WHERE
            <choose>
                <when test="column == 'authorId'">
                    author_id LIKE CONCAT('%', #{find}, '%')
                </when>
                <when test="column == 'postTitle'">
                    post_title LIKE CONCAT('%', #{find}, '%')
                </when>
                <when test="column == 'postContent'">
                    post_content LIKE CONCAT('%', #{find}, '%')
                </when>
                <when test="column == 'postTitle,authorId'">
                    (post_title LIKE CONCAT('%', #{find}, '%') OR author_id LIKE CONCAT('%', #{find}, '%'))
                </when>
                <when test="column == 'postTitle,postContent'">
                    (post_title LIKE CONCAT('%', #{find}, '%') OR post_content LIKE CONCAT('%', #{find}, '%'))
                </when>
                <when test="column == 'authorId,postContent'">
                    (author_id LIKE CONCAT('%', #{find}, '%') OR post_content LIKE CONCAT('%', #{find}, '%'))
                </when>
                <when test="column == 'postTitle,authorId,postContent'">
                    (post_title LIKE CONCAT('%', #{find}, '%') OR author_id LIKE CONCAT('%', #{find}, '%') OR post_content LIKE CONCAT('%', #{find}, '%'))
                </when>
            </choose>
        </if>
    </select>

    <select id="selectList" resultType="Post" parameterType="map">
        SELECT
            post_id,
            author_id,
            post_title,
            post_content,
            post_created_at,
            post_group,
            post_group_level,
            post_group_step,
            post_file,
            post_read_count
        FROM post
        <if test="column != null and find != null">
            WHERE
            <choose>
                <when test="column == 'authorId'">
                    author_id LIKE CONCAT('%', #{find}, '%')
                </when>
                <when test="column == 'postTitle'">
                    post_title LIKE CONCAT('%', #{find}, '%')
                </when>
                <when test="column == 'postContent'">
                    post_content LIKE CONCAT('%', #{find}, '%')
                </when>
                <when test="column == 'postTitle,authorId'">
                    (post_title LIKE CONCAT('%', #{find}, '%') OR author_id LIKE CONCAT('%', #{find}, '%'))
                </when>
                <when test="column == 'postTitle,postContent'">
                    (post_title LIKE CONCAT('%', #{find}, '%') OR post_content LIKE CONCAT('%', #{find}, '%'))
                </when>
                <when test="column == 'authorId,postContent'">
                    (author_id LIKE CONCAT('%', #{find}, '%') OR post_content LIKE CONCAT('%', #{find}, '%'))
                </when>
                <when test="column == 'postTitle,authorId,postContent'">
                    (post_title LIKE CONCAT('%', #{find}, '%') OR author_id LIKE CONCAT('%', #{find}, '%') OR post_content LIKE CONCAT('%', #{find}, '%'))
                </when>
            </choose>
        </if>
        ORDER BY post_id DESC
        LIMIT #{startRow}, #{pageSize}
    </select>

    <select id="selectOne" resultType="Post" parameterType="string">
        SELECT
            post_id,
            author_id,
            post_title,
            post_content,
            post_created_at,
            post_group,
            post_group_level,
            post_group_step,
            post_file,
            post_read_count
        FROM post
        WHERE post_id = #{post_id}
    </select>

    <update id="incrementReadCount" parameterType="string">
        UPDATE post
        SET post_read_count = post_read_count + 1
        WHERE post_id = #{post_id}
    </update>

    <insert id="insert" parameterType="Post" useGeneratedKeys="true" keyProperty="post_id">
        INSERT INTO post (
            author_id,
            post_title,
            post_content,
            post_created_at,
            post_group,
            post_group_level,
            post_group_step,
            post_file,
            post_read_count
        ) VALUES (
            #{authorId},
            #{postTitle},
            #{postContent},
            #{postCreatedAt},
            #{postGroup},
            #{postGroupLevel},
            #{postGroupStep},
            #{postFile},
            #{postReadCount}
        )
    </insert>
</mapper>