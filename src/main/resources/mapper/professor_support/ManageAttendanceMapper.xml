<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="MngAttendance">

	<select id="getCoursesInfoByPro" parameterType="string" resultType="java.util.Map">
    	SELECT c.course_name,
	           c.course_id,
	           c.course_period,
	           c.course_current_enrollment
	    FROM   course c
	    WHERE  1 = 1
	      AND  c.professor_id = #{professorId}
	</select>
    
    <!-- 데이터 조회 -->
    <select id="getAttendance" resultType="java.util.Map" parameterType="AttendanceDataDto">
	    SELECT     a.attendance_id,
		           a.student_id,
		           s.student_name,
		           a.attendance_status,
		           a.attendance_late, <!-- 지각 -->
		           a.attendance_absent, <!-- 결석 --> 
		           (
		               SELECT GROUP_CONCAT(ah.status ORDER BY ah.updated_date SEPARATOR ',')
		               FROM attendance_history ah
		               WHERE ah.attendance_id = a.attendance_id
		           ) AS history
	    FROM 		attendance a
	    JOIN 		student s ON a.student_id = s.student_id
	    WHERE 		a.course_id = #{courseId}
	    AND 		a.attendance_date = #{attendanceDate}
    </select>
    
    <insert id="insertAttendanceHistory" parameterType="java.util.Map">
    	INSERT INTO attendance_history (attendance_id, status, created_date, updated_date)
   		VALUES (#{attendanceId}, #{attendanceStatus}, NOW(), now())
    </insert>
    
    <update id="updateAttendance" parameterType="java.util.Map">
    	UPDATE  attendance
    	SET     attendance_status = #{attendanceStatus},
		        attendance_absent = (
		            SELECT COUNT(*)
		            FROM attendance_history ah
		            WHERE ah.attendance_id = #{attendanceId}
		            AND ah.status = '결석'
		        ),
		        attendance_late = (
		            SELECT COUNT(*)
		            FROM attendance_history ah
		            WHERE ah.attendance_id = #{attendanceId}
		            AND ah.status = '지각'
		        ),
		        attendance_date = #{attendanceDate}
	    WHERE   attendance_id = #{attendanceId}
    </update>
    
    
    
    
    
    
    
    
    
    
    
    
</mapper>